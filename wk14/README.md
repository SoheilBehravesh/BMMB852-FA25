*Hello* **Dr. Albert** 
# Assignment for week 14 - Perform an RNA-Seq differential gene expression study
The ultimate goal of the assignment is to perform a differential gene expression analysis using RNA-seq. We are going to expand the previous week assignment of the Staphylococus aureus. For doing so, we will first generate the count matrix by Hisat2 from the last week code. Second, we will perform differential gene expression analysis using EdgeR and DESeq2 and evaluate the identified genes for each of them and generate PCA plot and heatmap for each of them. Finally, we will perform functional enrichment analysis using gProfiler and Enrichr.
Please keep in mind that to perform the analysis I have eliminate the downsampling step (N=300000) because I wanted to test if I could reproduce the results. Therefore, If you wish to downsample the reads please add -X ${N} in front of the fastq-dump in the target of the reads in Makefile. The N is already preset to 300000 in the Makefile. or set the N to 179931 for 10x coverage.
## Step 1: Generate the count matrix using Hisat2 and featureCounts (using the code from last week
```bash
# create the design file manually by acquiring the srr numbers of the reads for the study and then add 'sample' and 'group' columns so the downstream analysis can be perform and understand which sample belongs to which group.
# or get the data design from the project number. in that case add two columns as 'sample' and 'group' to the csv file for the downstream analysis
bio search PRJNA887926 -H --csv > design.csv

# download the reference genome, index, and download the reads
micromamba activate bioinfo
make ref
make index
cat design.csv | parallel --colsep , --header : --eta -j 4 'make read SRR={srr_id}'

# Align the reads to the reference genome using Hisat2 and create bam files
cat design.csv | parallel --colsep , --header : --eta -j 4 'make run SRR={srr_id}'

# Generate the count matrix using featurecounts
featureCounts -p -T 4 -a ref/staphylcoc_aur.gtf -o counts.txt bam/*.bam
bio code
micromamba activate stats
Rscript src/r/format_featurecounts.r -c counts.txt -o counts.csv
```
#### Note:
 the format_featurecounts.r script modified in a way that the output count.csv file has the 'sample' names from the design file instead of the SRR numbers. This will help to perform the downstream analysis more easily.
The counts generated by featureCounts still find 72 genes wwhich is different from the original paper. so, what featurecounts does is to count the number of reads that overlap with each feature in the annotation file. in that case maybe there is an issue with the annotation file used in this analysis which is different from the annotated file used in the original paper. (I have to look through it)
 ### step2: perform differential gene expression analysis using edger and deseq2
 to perfor this step we will use the pre-prepared Rscripts from the 'src/r/' generateds from biocode.
 ```bash
Rscript src/r/edger.r -d design.csv -c counts.csv
Rscript src/r/deseq.r -d design.csv -c counts.csv
 ```
 out of the 72 rows, the edger fitted 33 rows (genes) with 6 of them as significant pval and 4 as significant FDRs. but deseq2 fitted 56 genes, and mong them 12 with sig pval and 1 with sig FDRs.

 although we do not simulate but now, let's evaluate the the counts data generated by each of the methods:
 ```bash
Rscript  src/r/evaluate_results.r  -a edger.csv -b deseq2.csv
```
based on the output of this evaluation out of 4 changes detected by edger, deseq found 1 that match. there are 3 false negatives, genes that were differentially expressed but deseq2 did not find them. And there are not any false positive.

now, let's generat PCA plot from the count data file produced by edger:
```bash
src/r/plot_pca.r -c edger.csv -d design.csv -o pca.pdf
```
[text](vscode-local:/Ubuntu/home/biouser/BMMB852-FA25/wk14/pca.pdf)
the pca plot is better than the downsampled one from the last week. but still the replicates are not cluster well and they overlapped. maybe because of low number of genes? PC1 explain 58% and PC2 explains 14%. the overall variance explanation looks good.

Now, let's generate heatmap for that:
```bash
src/r/plot_heatmap.r -c edger.csv -d design.csv -o heatmap.pdf
```
[text](vscode-local:/Ubuntu/home/biouser/BMMB852-FA25/wk14/heatmap.pdf)
Since the heatmap z-scored the counts so each number in the heatmap indicates how many standard deviations the expression level of a gene in a sample is from the mean expression level of that gene across other samples. The green lower expression and the red higher expression. the dark indicated the expression around the mean. so SAUSA300_RS02390 gene (last row) could be upregulated by the treatment.

You can print were differentially expressed genes found by edger using:
```bash
cat edger.csv | cut -f 1 -d ,  | head -10
```
However, please keep in mind that the first 4 of the results are the ones that are below the FDR (false discovery rate, an error rate) cutoff of 0.05.

### step 3: Dunctional enrichment analysis

we first use the following code to find the functional enrichment of the genes in the differential expression matrix ussing gprofiler:
```bash
bio gprofiler -c edger.csv -d 
```
but cince the databse does not have staphylococous aureus so we have to skip it.

Enrichr:
```bash
bio enrichr -c edger.csv
```
also we can not use this because the database is specific to mammals.

Therefore, unfortunately we are not able to perform functional enrichment analysis for staphylococus aureus.